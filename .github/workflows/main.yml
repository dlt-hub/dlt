name: dlt

on:
  pull_request:
    branches: [ master, devel ]

jobs:

  # checks wether anything outside docs has changed, if not, most of the tests can be skipped
  get_docs_changes:
    name: docs changes
    uses: ./.github/workflows/get_docs_changes.yml

  # if the PR is from a fork, we need to authorize the secrets access and remote destinations run with a lable
  authorize_run_from_fork:
    # run when label is assigned OR when we are not a fork
    if: ${{ github.event.label.name == 'ci from fork' || (github.event.pull_request.head.repo.full_name == github.repository && (github.event.action == 'opened' || github.event.action == 'synchronize'))}}
    runs-on: ubuntu-latest
    steps:
      - run: true
  
  lint:
    name: lint
    needs: get_docs_changes
    if: needs.get_docs_changes.outputs.changes_outside_docs == 'true'
    uses: ./.github/workflows/lint.yml

  test_common:
    needs: lint
    uses: ./.github/workflows/test_common.yml

  #
  # Destination and Sources local tests, do not provide secrets
  # Other tests that do not require remote connections
  #

  # TODO: maybe make matrix out of this for more local destination tests, such as dremio and clickhouse
  test_local_destinations:
    needs: test_common
    uses: ./.github/workflows/test_destinations_local.yml

  test_local_sources:
    needs: test_common
    uses: ./.github/workflows/test_sources_local.yml

  test_plus:
    needs: test_common
    uses: ./.github/workflows/test_plus.yml

  test_airflow:
    needs: test_common
    uses: ./.github/workflows/test_airflow.yml

  test_build_images:
    needs: test_common
    uses: ./.github/workflows/test_build_images.yml

  #
  # Remote destination tests and docs snippets, needs secrets, 
  # so we depend on authorize and forward secrets
  #
  test_destinations:
    needs: [test_common, authorize_run_from_fork]
    uses: ./.github/workflows/test_destinations.yml
    secrets: inherit
  test_docs_snippets:
    needs: [test_common, authorize_run_from_fork]
    uses: ./.github/workflows/test_doc_snippets.yml
    secrets: inherit
  test_destinations_remote:
    # TODO: only run after tests common
    needs: [authorize_run_from_fork] #, test_common]
    uses: ./.github/workflows/test_destinations_remote.yml
    secrets: inherit
    with:
      run_full_test_suite: ${{ contains(github.event.pull_request.labels.*.name, 'ci full') || github.event_name == 'schedule'}}


  #
  # Other tools and tests that require secrets
  #
  test_dbt_runner:
    needs: [test_common, authorize_run_from_fork]
    uses: ./.github/workflows/test_dbt_runner.yml
    secrets: inherit



