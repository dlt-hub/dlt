name: common | common

on:
  workflow_call:

env:
  RUNTIME__LOG_LEVEL: ERROR

  # we need the secrets only for the rest_api_pipeline tests which are in tests/sources
  # so we inject them only at the end
  SOURCES__GITHUB__ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # and also for the github_api_pipeline tests
  SOURCES__GITHUB_API_PIPELINE__ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ---------------------------------------------------------------------------
  # Build matrix: (profiles) Ã— (suites)
  # ---------------------------------------------------------------------------
  build-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - id: generate
        run: |
          profiles='[
            {"os":"macos-latest","python-version":"3.11","shell":"bash"},
            {"os":"ubuntu-latest","python-version":"3.9","shell":"bash"},
            {"os":"ubuntu-latest","python-version":"3.10","shell":"bash"},
            {"os":"ubuntu-latest","python-version":"3.11","shell":"bash"},
            {"os":"ubuntu-latest","python-version":"3.12","shell":"bash"},
            {"os":"ubuntu-latest","python-version":"3.13","shell":"bash"},
            {"os":"macos-14","python-version":"3.14","shell":"bash"},
            {"os":"ubuntu-latest","python-version":"3.11","shell":"bash","uv_sync_args":"--resolution lowest-direct"},
            {"os":"ubuntu-latest","python-version":"3.11","shell":"bash","uv_sync_args":"--upgrade"},
            {"os":"windows-latest","python-version":"3.11","shell":"cmd"},
            {"os":"windows-latest","python-version":"3.13","shell":"cmd"}
          ]'

          # Define which python versions are allowed to run which suites
          python_suite_map='{
            "3.9":  ["common-core","pipeline-min","pipeline-arrow","workspace","full","sql-database"],
            "3.10": ["common-core","pipeline-min","pipeline-arrow","workspace","full","sql-database"],
            "3.11": ["common-core","pipeline-min","pipeline-arrow","workspace","full","sql-database"],
            "3.12": ["common-core","pipeline-min","pipeline-arrow","workspace","full","sql-database"],
            "3.13": ["common-core","pipeline-min","pipeline-arrow","workspace","full","sql-database"],
            "3.14": ["common-core","pipeline-min"]
          }'

          jq -n \
            --argjson profiles "$profiles" \
            --argjson python_suite_map "$python_suite_map" \
            '{
              include: [
                $profiles[] as $p
                | ($python_suite_map[$p["python-version"]] // [])[] as $s
                | $p + { suite: $s }
              ]
            }' > matrix.json

          echo "matrix=$(cat matrix.json)" >> "$GITHUB_OUTPUT"

  # ---------------------------------------------------------------------------
  # Run tests
  # ---------------------------------------------------------------------------
  run_common:
    name: test (${{ matrix.os }} / py${{ matrix.python-version }} / ${{ matrix.suite }} / ${{ matrix.uv_sync_args || 'default' }})
    needs: build-matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.build-matrix.outputs.matrix) }}

    runs-on: ${{ matrix.os }}

    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
      - name: Check out
        uses: actions/checkout@master

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install tzdata on windows
        run: |
          cd %USERPROFILE%
          curl https://data.iana.org/time-zones/releases/tzdata2021e.tar.gz --output tzdata.tar.gz
          mkdir tzdata
          tar --extract --file tzdata.tar.gz --directory tzdata
          mkdir %USERPROFILE%\Downloads\tzdata
          copy tzdata %USERPROFILE%\Downloads\tzdata
          curl https://raw.githubusercontent.com/unicode-org/cldr/master/common/supplemental/windowsZones.xml --output %USERPROFILE%\Downloads\tzdata\windowsZones.xml
        if: runner.os == 'Windows'

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ matrix.python-version }}
          activate-environment: true
          enable-cache: true

      - name: Install dependencies
        run: make install-${{ matrix.suite }}
        env:
          UV_SYNC_ARGS: ${{ matrix.uv_sync_args }}

      - name: Run tests
        run: make test-${{ matrix.suite }}
        env:
          PYTEST_XDIST_N: auto
        
      - name: Install common-core-source deps
        if: matrix.suite == 'common-core'
        run: make install-common-core-source

      - name: Run minimal-deps source import test
        if: matrix.suite == 'common-core'
        run: uv run pytest tests/sources/test_minimal_dependencies.py

  # ---------------------------------------------------------------------------
  # Required gate
  # ---------------------------------------------------------------------------
  matrix_job_required_check:
    name: common | common tests
    needs: run_common
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check matrix job results
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: |
          echo "One or more matrix job tests failed or were cancelled." && exit 1
